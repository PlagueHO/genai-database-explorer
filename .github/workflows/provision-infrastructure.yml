name: Provision Infrastructure

on:
  workflow_call:
    inputs:
      ENVIRONMENT:
        description: "The environment to validate the application infrastructure for"
        required: true
        type: string
      BUILD_VERSION:
        description: "The version of the build to deploy to the application resources"
        required: true
        type: string
      AZURE_LOCATION:
        description: "The Azure region to deploy the application resources to"
        required: true
        type: string
      AZURE_ENV_NAME:
        description: "The name of the Azure environment"
        required: true
        type: string

    secrets:
      AZURE_TENANT_ID:
        description: "The Azure tenant ID to use for authentication to Azure for deployment"
        required: true
      AZURE_SUBSCRIPTION_ID:
        description: "The Azure subscription ID to use for authentication to Azure for deployment"
        required: true
      AZURE_CLIENT_ID:
        description: "The Azure client ID to use for authentication to Azure for deployment"
        required: true
      SQL_SERVER_USERNAME:
        description: "The SQL Server username for the application"
        required: true
      SQL_SERVER_PASSWORD:
        description: "The SQL Server password for the application"
        required: true

jobs:
  provision-infrastructure:
    name: Provision Infrastructure ${{ inputs.ENVIRONMENT }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.ENVIRONMENT }}
    env:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_ENV_NAME: ${{ inputs.AZURE_ENV_NAME }}
      AZURE_LOCATION: ${{ inputs.AZURE_LOCATION }}
      AZURE_PRINCIPAL_ID_TYPE: 'ServicePrincipal'
      SQL_SERVER_USERNAME: ${{ secrets.SQL_SERVER_USERNAME }}
      SQL_SERVER_PASSWORD: ${{ secrets.SQL_SERVER_PASSWORD }}
      AZURE_AI_SEARCH_DEPLOY: 'true'
      COSMOS_DB_DEPLOY: 'true'
      STORAGE_ACCOUNT_DEPLOY: 'true'

    outputs:
      AZURE_RESOURCE_GROUP: ${{ steps.get_endpoints.outputs.AZURE_RESOURCE_GROUP }}
      AZURE_PRINCIPAL_ID: ${{ steps.get_endpoints.outputs.AZURE_PRINCIPAL_ID }}
      AZURE_PRINCIPAL_ID_TYPE: ${{ steps.get_endpoints.outputs.AZURE_PRINCIPAL_ID_TYPE }}
      LOG_ANALYTICS_WORKSPACE_NAME: ${{ steps.get_endpoints.outputs.LOG_ANALYTICS_WORKSPACE_NAME }}
      LOG_ANALYTICS_RESOURCE_ID: ${{ steps.get_endpoints.outputs.LOG_ANALYTICS_RESOURCE_ID }}
      LOG_ANALYTICS_WORKSPACE_ID: ${{ steps.get_endpoints.outputs.LOG_ANALYTICS_WORKSPACE_ID }}
      APPLICATION_INSIGHTS_NAME: ${{ steps.get_endpoints.outputs.APPLICATION_INSIGHTS_NAME }}
      APPLICATION_INSIGHTS_RESOURCE_ID: ${{ steps.get_endpoints.outputs.APPLICATION_INSIGHTS_RESOURCE_ID }}
      APPLICATION_INSIGHTS_INSTRUMENTATION_KEY: ${{ steps.get_endpoints.outputs.APPLICATION_INSIGHTS_INSTRUMENTATION_KEY }}
      AZURE_AI_SEARCH_NAME: ${{ steps.get_endpoints.outputs.AZURE_AI_SEARCH_NAME }}
      AZURE_AI_SEARCH_ID: ${{ steps.get_endpoints.outputs.AZURE_AI_SEARCH_ID }}
      AZURE_AI_FOUNDRY_NAME: ${{ steps.get_endpoints.outputs.AZURE_AI_FOUNDRY_NAME }}
      AZURE_AI_FOUNDRY_ID: ${{ steps.get_endpoints.outputs.AZURE_AI_FOUNDRY_ID }}
      AZURE_AI_FOUNDRY_ENDPOINT: ${{ steps.get_endpoints.outputs.AZURE_AI_FOUNDRY_ENDPOINT }}
      AZURE_AI_FOUNDRY_RESOURCE_ID: ${{ steps.get_endpoints.outputs.AZURE_AI_FOUNDRY_RESOURCE_ID }}
      SQL_SERVER_NAME: ${{ steps.get_endpoints.outputs.SQL_SERVER_NAME }}
      SQL_SERVER_RESOURCE_ID: ${{ steps.get_endpoints.outputs.SQL_SERVER_RESOURCE_ID }}
      SQL_DATABASE_ENDPOINT: ${{ steps.get_endpoints.outputs.SQL_DATABASE_ENDPOINT }}
      COSMOS_DB_ACCOUNT_NAME: ${{ steps.get_endpoints.outputs.COSMOS_DB_ACCOUNT_NAME }}
      COSMOS_DB_ACCOUNT_RESOURCE_ID: ${{ steps.get_endpoints.outputs.COSMOS_DB_ACCOUNT_RESOURCE_ID }}
      COSMOS_DB_ACCOUNT_ENDPOINT: ${{ steps.get_endpoints.outputs.COSMOS_DB_ACCOUNT_ENDPOINT }}
      STORAGE_ACCOUNT_NAME: ${{ steps.get_endpoints.outputs.STORAGE_ACCOUNT_NAME }}
      STORAGE_ACCOUNT_RESOURCE_ID: ${{ steps.get_endpoints.outputs.STORAGE_ACCOUNT_RESOURCE_ID }}
      STORAGE_ACCOUNT_BLOB_ENDPOINT: ${{ steps.get_endpoints.outputs.STORAGE_ACCOUNT_BLOB_ENDPOINT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install azd
        uses: Azure/setup-azd@v2.1.0

      - name: Authenticate azd (Federated Credentials)
        run: |
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --federated-credential-provider "github" \
            --tenant-id "$AZURE_TENANT_ID"

      - name: Provision Infrastructure
        run: azd provision --no-prompt

      - name: Get Output Endpoints
        id: get_endpoints
        run: |
          # Define the output variables we want to extract and pass through
          OUTPUT_VARS=(
            "AZURE_RESOURCE_GROUP"
            "AZURE_PRINCIPAL_ID"
            "AZURE_PRINCIPAL_ID_TYPE"
            "LOG_ANALYTICS_WORKSPACE_NAME"
            "LOG_ANALYTICS_RESOURCE_ID"
            "LOG_ANALYTICS_WORKSPACE_ID"
            "APPLICATION_INSIGHTS_NAME"
            "APPLICATION_INSIGHTS_RESOURCE_ID"
            "APPLICATION_INSIGHTS_INSTRUMENTATION_KEY"
            "AZURE_AI_SEARCH_NAME"
            "AZURE_AI_SEARCH_ID"
            "AZURE_AI_FOUNDRY_NAME"
            "AZURE_AI_FOUNDRY_ID"
            "AZURE_AI_FOUNDRY_RESOURCE_ID"
            "SQL_SERVER_NAME"
            "SQL_SERVER_RESOURCE_ID"
            "SQL_DATABASE_ENDPOINT"
            "COSMOS_DB_ACCOUNT_NAME"
            "COSMOS_DB_ACCOUNT_RESOURCE_ID"
            "COSMOS_DB_ACCOUNT_ENDPOINT"
            "STORAGE_ACCOUNT_NAME"
            "STORAGE_ACCOUNT_RESOURCE_ID"
            "STORAGE_ACCOUNT_BLOB_ENDPOINT"
          )
          
          # Get all outputs from azd env get-values
          echo "Getting azd environment outputs..."
          AZD_OUTPUTS=$(azd env get-values)
          
          # Extract and set each output variable
          for VAR_NAME in "${OUTPUT_VARS[@]}"; do
            VAR_VALUE=$(echo "$AZD_OUTPUTS" | grep "^${VAR_NAME}=" | cut -d'=' -f2- | xargs)
            echo "$VAR_NAME=$VAR_VALUE" >> $GITHUB_OUTPUT
            echo "Set $VAR_NAME=$VAR_VALUE"
          done
          
          # Get the Azure AI Foundry OpenAI endpoint using Azure CLI
          echo "Retrieving Azure AI Foundry OpenAI endpoint..."
          AZURE_AI_FOUNDRY_NAME=$(echo "$AZD_OUTPUTS" | grep "^AZURE_AI_FOUNDRY_NAME=" | cut -d'=' -f2- | xargs)
          AZURE_RESOURCE_GROUP=$(echo "$AZD_OUTPUTS" | grep "^AZURE_RESOURCE_GROUP=" | cut -d'=' -f2- | xargs)
          
          if [[ -n "$AZURE_AI_FOUNDRY_NAME" && -n "$AZURE_RESOURCE_GROUP" ]]; then
            echo "Looking up OpenAI endpoint for AI Foundry resource: $AZURE_AI_FOUNDRY_NAME in resource group: $AZURE_RESOURCE_GROUP"
            
            # Get the AI Services endpoint and derive the OpenAI endpoint
            # Azure AI Services with kind 'AIServices' provides OpenAI endpoints at a specific path
            AI_SERVICES_ENDPOINT=$(az cognitiveservices account show \
              --name "$AZURE_AI_FOUNDRY_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --query "properties.endpoint" \
              --output tsv 2>/dev/null || echo "")
            
            if [[ -n "$AI_SERVICES_ENDPOINT" ]]; then
              # For Azure AI Services (AIServices kind), the OpenAI endpoint is the same as the main endpoint
              # The endpoint format is typically: https://<name>.cognitiveservices.azure.com/
              AZURE_AI_FOUNDRY_ENDPOINT="$AI_SERVICES_ENDPOINT"
              echo "AZURE_AI_FOUNDRY_ENDPOINT=$AZURE_AI_FOUNDRY_ENDPOINT" >> $GITHUB_OUTPUT
              echo "Set AZURE_AI_FOUNDRY_ENDPOINT=$AZURE_AI_FOUNDRY_ENDPOINT"
            else
              echo "Warning: Could not retrieve AI Services endpoint for $AZURE_AI_FOUNDRY_NAME"
              echo "AZURE_AI_FOUNDRY_ENDPOINT=" >> $GITHUB_OUTPUT
              echo "Set AZURE_AI_FOUNDRY_ENDPOINT=(empty)"
            fi
          else
            echo "Warning: Azure AI Foundry name or resource group not found in outputs"
            echo "AZURE_AI_FOUNDRY_ENDPOINT=" >> $GITHUB_OUTPUT
            echo "Set AZURE_AI_FOUNDRY_ENDPOINT=(empty)"
          fi
